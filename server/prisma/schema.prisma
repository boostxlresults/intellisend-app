generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  publicName  String
  industry    String?
  websiteUrl  String?
  mainPhone   String?
  brandVoice  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  numbers              TenantNumber[]
  users                User[]
  contacts             Contact[]
  suppressions         Suppression[]
  segments             Segment[]
  campaigns            Campaign[]
  conversations        Conversation[]
  messages             Message[]
  aiPersonas           AiPersona[]
  knowledgeArticles    KnowledgeBaseArticle[]
  settings             TenantSettings?
  messageEvents        MessageEvent[]
  integration          TenantIntegration?
  memberships          UserTenantMembership[]
  tags                 Tag[]
  sequences            Sequence[]
  serviceTitanConfig   ServiceTitanConfig?
}

model TenantSettings {
  id                  String   @id @default(uuid())
  tenantId            String   @unique
  timezone            String   @default("America/Phoenix")
  quietHoursStart     Int      @default(1200)
  quietHoursEnd       Int      @default(480)
  defaultFromNumberId String?
  sendRatePerMinute   Int      @default(30)
  sendJitterMinMs     Int      @default(1000)
  sendJitterMaxMs     Int      @default(5000)
  notificationEmail   String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  defaultFromNumber TenantNumber? @relation(fields: [defaultFromNumberId], references: [id], onDelete: SetNull)
}

model TenantIntegration {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  twilioAccountSid      String?
  twilioAuthToken       String?
  twilioMessagingServiceSid String?
  twilioConfigured      Boolean  @default(false)
  twilioValidatedAt     DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantNumber {
  id          String   @id @default(uuid())
  tenantId    String
  phoneNumber String
  label       String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  settings TenantSettings[]

  @@index([phoneNumber])
}

enum UserRole {
  ADMIN
  AGENT
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
}

model User {
  id           String   @id @default(uuid())
  tenantId     String?
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(AGENT)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant      Tenant?               @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  messages    Message[]
  memberships UserTenantMembership[]
}

model UserTenantMembership {
  id        String         @id @default(uuid())
  userId    String
  tenantId  String
  role      MembershipRole @default(MEMBER)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

enum CustomerType {
  LEAD
  CUSTOMER
  PAST_CUSTOMER
  OTHER
}

model Contact {
  id               String        @id @default(uuid())
  tenantId         String
  firstName        String
  lastName         String
  phone            String
  email            String?
  address          String?
  city             String?
  state            String?
  zip              String?
  leadSource       String?
  customerType     CustomerType  @default(LEAD)
  consentSource    String?
  consentTimestamp DateTime?
  lastContactedAt  DateTime?
  lastRepliedAt    DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tags            ContactTag[]
  segmentMembers  SegmentMember[]
  conversations   Conversation[]
  messages        Message[]

  @@index([phone])
  @@index([tenantId])
}

model Tag {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  color     String?
  createdAt DateTime @default(now())

  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts ContactTag[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model ContactTag {
  id        String @id @default(uuid())
  contactId String
  tagId     String

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@index([tagId])
}

model Suppression {
  id        String   @id @default(uuid())
  tenantId  String
  phone     String
  reason    String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, phone])
  @@index([phone])
}

enum SegmentType {
  STATIC
  DYNAMIC
}

model Segment {
  id             String      @id @default(uuid())
  tenantId       String
  name           String
  type           SegmentType @default(STATIC)
  definitionJson String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members   SegmentMember[]
  campaigns Campaign[]
}

model SegmentMember {
  id        String @id @default(uuid())
  segmentId String
  contactId String

  segment Segment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([segmentId, contactId])
}

enum CampaignType {
  BLAST
  DRIP
}

enum CampaignStatus {
  DRAFT
  PENDING_APPROVAL
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  REJECTED
}

model Campaign {
  id          String         @id @default(uuid())
  tenantId    String
  name        String
  description String?
  type        CampaignType   @default(BLAST)
  status      CampaignStatus @default(DRAFT)
  segmentId   String?
  startAt     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  complianceCheckedAt     DateTime?
  complianceCheckedBy     String?
  complianceConsentVerified Boolean @default(false)
  complianceOptOutIncluded  Boolean @default(false)
  complianceQuietHoursOk   Boolean @default(false)
  complianceContentReviewed Boolean @default(false)
  complianceNotes         String?

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  segment  Segment?          @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  steps    CampaignStep[]
  messages Message[]
  variants CampaignVariant[]
}

model CampaignStep {
  id           String   @id @default(uuid())
  campaignId   String
  order        Int
  delayMinutes Int      @default(0)
  bodyTemplate String
  useAiAssist  Boolean  @default(false)
  createdAt    DateTime @default(now())

  campaign Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages Message[]
}

enum ConversationStatus {
  OPEN
  CLOSED
}

model Conversation {
  id            String             @id @default(uuid())
  tenantId      String
  contactId     String
  status        ConversationStatus @default(OPEN)
  lastMessageAt DateTime           @default(now())
  needsAttention Boolean           @default(false)
  serviceTitanBookingId       String?
  serviceTitanBookingCreatedAt DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact  Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([tenantId])
  @@index([contactId])
  @@index([tenantId, needsAttention, lastMessageAt])
}

enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageChannel {
  SMS
}

model Message {
  id              String           @id @default(uuid())
  conversationId  String
  tenantId        String
  contactId       String
  direction       MessageDirection
  channel         MessageChannel   @default(SMS)
  body            String
  mediaUrl        String?          // MMS media URL
  fromNumber      String
  toNumber        String
  twilioMessageSid String?
  status          String?
  errorCode       String?
  isAiGenerated   Boolean          @default(false)
  createdByUserId String?
  campaignId      String?
  campaignStepId  String?
  variantId       String?          // A/B test variant
  createdAt       DateTime         @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  campaign     Campaign?    @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignStep CampaignStep? @relation(fields: [campaignStepId], references: [id], onDelete: SetNull)

  @@index([twilioMessageSid])
  @@index([campaignId, campaignStepId, contactId])
}

model AiPersona {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  description  String?
  systemPrompt String
  canAutoReply Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model KnowledgeBaseArticle {
  id         String   @id @default(uuid())
  tenantId   String
  title      String
  topic      String
  content    String
  sourceType String   @default("manual")
  sourceUrl  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

enum MessageEventType {
  SENT
  DELIVERED
  FAILED
  SUPPRESSED
  QUIET_HOURS_BLOCKED
  RATE_LIMITED
  OPT_OUT
  COMPLAINT
  CARRIER_BLOCKED
}

enum ConsentSource {
  IMPORT
  WEB_FORM
  SMS_KEYWORD
  MANUAL
  API
}

model ConsentRecord {
  id            String        @id @default(uuid())
  tenantId      String
  contactId     String
  phone         String
  consentGiven  Boolean       @default(true)
  consentSource ConsentSource
  sourceDetails String?
  ipAddress     String?
  userAgent     String?
  consentText   String?
  givenAt       DateTime      @default(now())
  revokedAt     DateTime?
  createdAt     DateTime      @default(now())

  @@index([tenantId, phone])
  @@index([contactId])
}

model MessageEvent {
  id         String           @id @default(uuid())
  tenantId   String
  contactId  String?
  phone      String
  eventType  MessageEventType
  messageId  String?
  campaignId String?
  errorCode  String?
  errorMessage String?
  createdAt  DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, eventType])
  @@index([tenantId, createdAt])
  @@index([campaignId])
}

enum OutboundQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  RATE_LIMITED
  SUPPRESSED
}

model OutboundMessageQueue {
  id             String              @id @default(uuid())
  tenantId       String
  campaignId     String?
  campaignStepId String?
  variantId      String?             // A/B test variant
  sequenceEnrollmentStepId String?   // For sequence messages
  contactId      String
  phone          String
  body           String
  mediaUrl       String?             // MMS media URL
  fromNumber     String
  status         OutboundQueueStatus @default(PENDING)
  scheduledAt    DateTime            @default(now())
  processAfter   DateTime            @default(now())
  processedAt    DateTime?
  attempts       Int                 @default(0)
  errorMessage   String?
  twilioSid      String?
  createdAt      DateTime            @default(now())

  @@index([tenantId, status, processAfter])
  @@index([campaignId])
  @@index([status, processAfter])
}

// ============================================
// DRIP SEQUENCES (Automated Multi-Step Campaigns)
// ============================================

enum SequenceStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

model Sequence {
  id          String         @id @default(uuid())
  tenantId    String
  name        String
  description String?
  status      SequenceStatus @default(ACTIVE)
  triggerType String         @default("manual") // manual, tag_added, form_submit, etc
  triggerConfig String?      // JSON config for trigger
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  steps       SequenceStep[]
  enrollments SequenceEnrollment[]

  @@index([tenantId])
}

model SequenceStep {
  id            String   @id @default(uuid())
  sequenceId    String
  order         Int
  delayMinutes  Int      @default(0) // Delay after previous step (0 = immediate for first step)
  delayUnit     String   @default("minutes") // minutes, hours, days
  bodyTemplate  String
  useAiAssist   Boolean  @default(false)
  mediaUrl      String?  // For MMS
  createdAt     DateTime @default(now())

  sequence    Sequence                  @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  enrollments SequenceEnrollmentStep[]

  @@index([sequenceId, order])
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

model SequenceEnrollment {
  id          String           @id @default(uuid())
  sequenceId  String
  contactId   String
  status      EnrollmentStatus @default(ACTIVE)
  currentStep Int              @default(0)
  enrolledAt  DateTime         @default(now())
  completedAt DateTime?
  pausedAt    DateTime?

  sequence Sequence                  @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  steps    SequenceEnrollmentStep[]

  @@unique([sequenceId, contactId])
  @@index([status])
}

model SequenceEnrollmentStep {
  id           String    @id @default(uuid())
  enrollmentId String
  stepId       String
  scheduledAt  DateTime
  sentAt       DateTime?
  skipped      Boolean   @default(false)
  skipReason   String?

  enrollment SequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  step       SequenceStep       @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([scheduledAt, sentAt])
}

// ============================================
// A/B TESTING
// ============================================

model CampaignVariant {
  id           String   @id @default(uuid())
  campaignId   String
  name         String   // "Variant A", "Variant B"
  bodyTemplate String
  splitPercent Int      @default(50) // Percentage of audience
  mediaUrl     String?
  createdAt    DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

// ============================================
// LINK TRACKING & SHORT URLs
// ============================================

model TrackedLink {
  id          String   @id @default(uuid())
  tenantId    String
  shortCode   String   @unique
  originalUrl String
  campaignId  String?
  sequenceId  String?
  createdAt   DateTime @default(now())

  clicks LinkClick[]

  @@index([tenantId])
  @@index([shortCode])
}

model LinkClick {
  id            String   @id @default(uuid())
  trackedLinkId String
  contactId     String?
  phone         String?
  userAgent     String?
  ipAddress     String?
  clickedAt     DateTime @default(now())

  trackedLink TrackedLink @relation(fields: [trackedLinkId], references: [id], onDelete: Cascade)

  @@index([trackedLinkId])
  @@index([contactId])
}

// ============================================
// MESSAGE TEMPLATES
// ============================================

enum TemplateCategory {
  APPOINTMENT_REMINDER
  REVIEW_REQUEST
  SEASONAL_PROMO
  RE_ENGAGEMENT
  WELCOME
  CONFIRMATION
  FOLLOW_UP
  CUSTOM
}

model MessageTemplate {
  id          String           @id @default(uuid())
  tenantId    String?          // null = system-wide template
  name        String
  category    TemplateCategory @default(CUSTOM)
  bodyTemplate String
  mediaUrl    String?
  isSystemTemplate Boolean     @default(false)
  variables   String?          // JSON array of variable names like ["firstName", "appointmentDate"]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([tenantId])
  @@index([category])
}

// ============================================
// BILLING & USAGE METERING
// ============================================

enum PlanType {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model TenantPlan {
  id                String   @id @default(uuid())
  tenantId          String   @unique
  planType          PlanType @default(FREE)
  monthlyMessageLimit Int    @default(500)
  monthlyCost       Int      @default(0) // in cents
  stripeCustomerId  String?
  stripeSubscriptionId String?
  currentPeriodStart DateTime?
  currentPeriodEnd  DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([stripeCustomerId])
}

model UsageRecord {
  id           String   @id @default(uuid())
  tenantId     String
  periodStart  DateTime
  periodEnd    DateTime
  smsCount     Int      @default(0)
  mmsCount     Int      @default(0)
  segmentCount Int      @default(0) // SMS segments (longer messages count as multiple)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId, periodStart])
  @@index([tenantId])
}

// ============================================
// WHITE-LABEL BRANDING
// ============================================

model TenantBranding {
  id               String   @id @default(uuid())
  tenantId         String   @unique
  logoUrl          String?
  faviconUrl       String?
  primaryColor     String   @default("#3B82F6")
  secondaryColor   String   @default("#1E40AF")
  companyName      String?  // Override display name
  supportEmail     String?
  customDomain     String?  // e.g., sms.mybrand.com
  customCss        String?  // Additional CSS overrides
  footerText       String?
  hideIntelliSend  Boolean  @default(false) // Hide "Powered by IntelliSend"
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([customDomain])
}

// ============================================
// SERVICETITAN INTEGRATION
// ============================================

model ServiceTitanConfig {
  id                   String   @id @default(uuid())
  tenantId             String   @unique
  tenantApiBaseUrl     String
  serviceTitanTenantId String
  appKey               String   // App Key from Developer Portal (ST-App-Key header)
  clientId             String   // Client ID from ServiceTitan tenant
  clientSecret         String   // Client Secret from ServiceTitan tenant
  bookingProvider      String   @default("IntelliSend-SMS")
  bookingProviderId    String?  // Numeric ID from ServiceTitan Booking Provider Tags
  enabled              Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

enum ServiceTitanBookingJobStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
}

model ServiceTitanBookingJob {
  id              String   @id @default(uuid())
  messageSid      String   @unique
  conversationId  String
  tenantId        String
  contactId       String
  toNumber        String
  messageBody     String
  status          ServiceTitanBookingJobStatus @default(PENDING)
  bookingId       String?
  attempts        Int      @default(0)
  maxAttempts     Int      @default(3)
  nextRunAt       DateTime @default(now())
  leaseExpiresAt  DateTime?
  errorMessage    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([conversationId])
  @@index([tenantId])
  @@index([status, nextRunAt])
}
