generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  publicName  String
  industry    String?
  websiteUrl  String?
  mainPhone   String?
  brandVoice  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  numbers           TenantNumber[]
  users             User[]
  contacts          Contact[]
  suppressions      Suppression[]
  segments          Segment[]
  campaigns         Campaign[]
  conversations     Conversation[]
  messages          Message[]
  aiPersonas        AiPersona[]
  knowledgeArticles KnowledgeBaseArticle[]
  settings          TenantSettings?
  messageEvents     MessageEvent[]
  integration       TenantIntegration?
  memberships       UserTenantMembership[]
}

model TenantSettings {
  id                  String   @id @default(uuid())
  tenantId            String   @unique
  timezone            String   @default("America/Phoenix")
  quietHoursStart     Int      @default(1200)
  quietHoursEnd       Int      @default(480)
  defaultFromNumberId String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  defaultFromNumber TenantNumber? @relation(fields: [defaultFromNumberId], references: [id], onDelete: SetNull)
}

model TenantIntegration {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  twilioAccountSid      String?
  twilioAuthToken       String?
  twilioMessagingServiceSid String?
  twilioConfigured      Boolean  @default(false)
  twilioValidatedAt     DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantNumber {
  id          String   @id @default(uuid())
  tenantId    String
  phoneNumber String
  label       String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  settings TenantSettings[]

  @@index([phoneNumber])
}

enum UserRole {
  ADMIN
  AGENT
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
}

model User {
  id           String   @id @default(uuid())
  tenantId     String?
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(AGENT)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant      Tenant?               @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  messages    Message[]
  memberships UserTenantMembership[]
}

model UserTenantMembership {
  id        String         @id @default(uuid())
  userId    String
  tenantId  String
  role      MembershipRole @default(MEMBER)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

enum CustomerType {
  LEAD
  CUSTOMER
  PAST_CUSTOMER
  OTHER
}

model Contact {
  id               String        @id @default(uuid())
  tenantId         String
  firstName        String
  lastName         String
  phone            String
  email            String?
  address          String?
  city             String?
  state            String?
  zip              String?
  leadSource       String?
  customerType     CustomerType  @default(LEAD)
  consentSource    String?
  consentTimestamp DateTime?
  lastContactedAt  DateTime?
  lastRepliedAt    DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tags            ContactTag[]
  segmentMembers  SegmentMember[]
  conversations   Conversation[]
  messages        Message[]

  @@index([phone])
  @@index([tenantId])
}

model ContactTag {
  id        String @id @default(uuid())
  contactId String
  tag       String

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([tag])
}

model Suppression {
  id        String   @id @default(uuid())
  tenantId  String
  phone     String
  reason    String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, phone])
  @@index([phone])
}

enum SegmentType {
  STATIC
  DYNAMIC
}

model Segment {
  id             String      @id @default(uuid())
  tenantId       String
  name           String
  type           SegmentType @default(STATIC)
  definitionJson String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members   SegmentMember[]
  campaigns Campaign[]
}

model SegmentMember {
  id        String @id @default(uuid())
  segmentId String
  contactId String

  segment Segment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([segmentId, contactId])
}

enum CampaignType {
  BLAST
  DRIP
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
}

model Campaign {
  id          String         @id @default(uuid())
  tenantId    String
  name        String
  description String?
  type        CampaignType   @default(BLAST)
  status      CampaignStatus @default(DRAFT)
  segmentId   String?
  startAt     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  segment  Segment?       @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  steps    CampaignStep[]
  messages Message[]
}

model CampaignStep {
  id           String   @id @default(uuid())
  campaignId   String
  order        Int
  delayMinutes Int      @default(0)
  bodyTemplate String
  useAiAssist  Boolean  @default(false)
  createdAt    DateTime @default(now())

  campaign Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages Message[]
}

enum ConversationStatus {
  OPEN
  CLOSED
}

model Conversation {
  id            String             @id @default(uuid())
  tenantId      String
  contactId     String
  status        ConversationStatus @default(OPEN)
  lastMessageAt DateTime           @default(now())
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact  Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([tenantId])
  @@index([contactId])
}

enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageChannel {
  SMS
}

model Message {
  id              String           @id @default(uuid())
  conversationId  String
  tenantId        String
  contactId       String
  direction       MessageDirection
  channel         MessageChannel   @default(SMS)
  body            String
  fromNumber      String
  toNumber        String
  twilioMessageSid String?
  status          String?
  errorCode       String?
  isAiGenerated   Boolean          @default(false)
  createdByUserId String?
  campaignId      String?
  campaignStepId  String?
  createdAt       DateTime         @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  campaign     Campaign?    @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignStep CampaignStep? @relation(fields: [campaignStepId], references: [id], onDelete: SetNull)

  @@index([twilioMessageSid])
  @@index([campaignId, campaignStepId, contactId])
}

model AiPersona {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  description  String?
  systemPrompt String
  canAutoReply Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model KnowledgeBaseArticle {
  id         String   @id @default(uuid())
  tenantId   String
  title      String
  topic      String
  content    String
  sourceType String   @default("manual")
  sourceUrl  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

enum MessageEventType {
  SENT
  DELIVERED
  FAILED
  SUPPRESSED
  QUIET_HOURS_BLOCKED
}

model MessageEvent {
  id         String           @id @default(uuid())
  tenantId   String
  contactId  String?
  phone      String
  eventType  MessageEventType
  messageId  String?
  campaignId String?
  errorCode  String?
  errorMessage String?
  createdAt  DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, eventType])
  @@index([tenantId, createdAt])
  @@index([campaignId])
}
